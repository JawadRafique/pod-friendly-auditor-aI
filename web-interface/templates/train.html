<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Train Model - Pod Detection Auditor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="fas fa-eye"></i> Pod Detection Auditor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link" href="/upload">Upload</a>
                <a class="nav-link active" href="/train">Train</a>
                <a class="nav-link" href="/inference">Test</a>
                <a class="nav-link" href="/status">Status</a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card shadow">
                    <div class="card-header">
                        <h4><i class="fas fa-brain"></i> Train Detection Model</h4>
                    </div>
                    <div class="card-body">
                        <!-- Training Options -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-play-circle fa-3x text-success mb-3"></i>
                                        <h5>Initial Training</h5>
                                        <p class="text-muted">Start training from scratch with YOLO11 Nano</p>
                                        <button id="startInitialTraining" class="btn btn-success">
                                            <i class="fas fa-play"></i> Start Initial Training
                                        </button>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100">
                                    <div class="card-body text-center">
                                        <i class="fas fa-refresh fa-3x text-info mb-3"></i>
                                        <h5>Fine-Tuning</h5>
                                        <p class="text-muted">Continue training from existing model</p>
                                        <button id="startFineTuning" class="btn btn-info">
                                            <i class="fas fa-redo"></i> Fine-Tune Model
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Fine-tuning Options -->
                        <div id="fineTuningOptions" class="card mb-4" style="display: none;">
                            <div class="card-header">
                                <h6>Fine-Tuning Configuration</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label">Version Name</label>
                                    <input type="text" class="form-control" id="versionName" value="v2" placeholder="e.g., v2, v3, experiment1">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Previous Model (optional)</label>
                                    <input type="text" class="form-control" id="previousModel" placeholder="Leave empty to use latest model">
                                    <small class="text-muted">Full path to .pt file, or leave empty to auto-detect</small>
                                </div>
                            </div>
                        </div>

                        <!-- Training Progress -->
                        <div id="trainingProgress" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h6><i class="fas fa-spinner fa-spin"></i> Training in Progress</h6>
                                </div>
                                <div class="card-body">
                                    <div id="trainingOutput" class="bg-dark text-light p-3 rounded" style="height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.9em;">
                                        <div>Starting training...</div>
                                        <div>‚ö†Ô∏è This will take several hours on Intel CPU</div>
                                        <div>üí° You can close this browser - training continues in Docker</div>
                                    </div>
                                    <div class="mt-3">
                                        <button id="stopTraining" class="btn btn-danger btn-sm">
                                            <i class="fas fa-stop"></i> Stop Training
                                        </button>
                                        <button id="refreshOutput" class="btn btn-secondary btn-sm">
                                            <i class="fas fa-refresh"></i> Refresh Output
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Training Info -->
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle"></i> Training Information</h6>
                            <ul class="mb-0">
                                <li><strong>CPU Training:</strong> Optimized for Intel MacBook (will be slow)</li>
                                <li><strong>Initial Training:</strong> 50 epochs, ~2-4 hours depending on dataset size</li>
                                <li><strong>Fine-tuning:</strong> 30 epochs, ~1-2 hours</li>
                                <li><strong>Models saved to:</strong> /models directory in your project</li>
                                <li><strong>Tip:</strong> Start with 10-20 annotated images per class for good results</li>
                            </ul>
                        </div>
                    </div>
                </div>

                <!-- Quick Commands -->
                <div class="card shadow mt-4">
                    <div class="card-header">
                        <h5><i class="fas fa-terminal"></i> Quick Commands</h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted">You can also run these commands directly in Docker:</p>
                        <div class="bg-dark text-light p-3 rounded mb-3">
                            <code>
                                # Initial training<br>
                                docker exec yolo-trainer python /usr/src/app/scripts/train_initial.py<br><br>
                                # Fine-tuning<br>
                                docker exec yolo-trainer python /usr/src/app/scripts/retrain.py v2<br><br>
                                # Check training status<br>
                                docker exec yolo-trainer ls -la /usr/src/app/runs/
                            </code>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let trainingPollInterval;

        document.getElementById('startInitialTraining').addEventListener('click', function() {
            if (confirm('Start initial training? This will take several hours.')) {
                startTraining('initial');
            }
        });

        document.getElementById('startFineTuning').addEventListener('click', function() {
            document.getElementById('fineTuningOptions').style.display = 'block';
            this.style.display = 'none';
            
            // Add confirm button for fine-tuning
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'btn btn-info';
            confirmBtn.innerHTML = '<i class="fas fa-check"></i> Confirm Fine-Tuning';
            confirmBtn.onclick = function() {
                const version = document.getElementById('versionName').value || 'v2';
                const previousModel = document.getElementById('previousModel').value;
                if (confirm(`Start fine-tuning version ${version}? This will take 1-2 hours.`)) {
                    startFineTuning(version, previousModel);
                }
            };
            document.getElementById('fineTuningOptions').querySelector('.card-body').appendChild(confirmBtn);
        });

        function startTraining(type) {
            const formData = new FormData();
            formData.append('training_type', type);
            
            fetch('/train', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTrainingProgress(data.message);
                    startProgressPolling();
                } else {
                    alert('Error starting training: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting training');
            });
        }

        function startFineTuning(version, previousModel) {
            const formData = new FormData();
            formData.append('training_type', 'retrain');
            formData.append('version', version);
            if (previousModel) {
                formData.append('previous_model', previousModel);
            }
            
            fetch('/train', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showTrainingProgress(data.message);
                    startProgressPolling();
                } else {
                    alert('Error starting fine-tuning: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error starting fine-tuning');
            });
        }

        function showTrainingProgress(message) {
            document.getElementById('trainingProgress').style.display = 'block';
            addOutputLine(message);
            
            // Hide training buttons
            document.getElementById('startInitialTraining').disabled = true;
            document.getElementById('startFineTuning').disabled = true;
        }

        function addOutputLine(text) {
            const output = document.getElementById('trainingOutput');
            const line = document.createElement('div');
            line.textContent = new Date().toLocaleTimeString() + ' - ' + text;
            output.appendChild(line);
            output.scrollTop = output.scrollHeight;
        }

        function startProgressPolling() {
            // This would need to be implemented with actual progress checking
            // For now, just simulate some progress updates
            trainingPollInterval = setInterval(() => {
                addOutputLine('Training in progress...');
            }, 30000); // Update every 30 seconds
        }

        document.getElementById('refreshOutput').addEventListener('click', function() {
            addOutputLine('Output refreshed - check Docker container for real-time logs');
        });

        document.getElementById('stopTraining').addEventListener('click', function() {
            if (confirm('Are you sure you want to stop training?')) {
                clearInterval(trainingPollInterval);
                addOutputLine('Training stopped by user');
                document.getElementById('startInitialTraining').disabled = false;
                document.getElementById('startFineTuning').disabled = false;
            }
        });
    </script>
</body>
</html>