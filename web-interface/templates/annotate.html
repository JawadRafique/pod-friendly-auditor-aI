<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annotate Image - Pod Detection Auditor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .annotation-container {
            position: relative;
            display: inline-block;
            max-width: 100%;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        
        .annotation-image {
            max-width: 100%;
            height: auto;
            display: block;
        }
        
        .bounding-box {
            position: absolute;
            border: 2px solid #007bff;
            background: rgba(0, 123, 255, 0.1);
            cursor: move;
            min-width: 20px;
            min-height: 20px;
        }
        
        .bounding-box:hover {
            border-color: #0056b3;
            background: rgba(0, 123, 255, 0.2);
        }
        
        .bounding-box.selected {
            border-color: #28a745;
            background: rgba(40, 167, 69, 0.2);
        }
        
        .box-label {
            position: absolute;
            top: -25px;
            left: 0;
            background: #007bff;
            color: white;
            padding: 2px 6px;
            font-size: 12px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .selected .box-label {
            background: #28a745;
        }
        
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background: #fff;
            border: 2px solid #007bff;
            border-radius: 50%;
        }
        
        .resize-handle.bottom-right {
            bottom: -4px;
            right: -4px;
            cursor: se-resize;
        }
        
        .class-selector {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1050;
            display: none;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="fas fa-eye"></i> Pod Detection Auditor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="/">Dashboard</a>
                <a class="nav-link" href="/upload">Upload</a>
                <a class="nav-link" href="/train">Train</a>
                <a class="nav-link" href="/inference">Test</a>
                <a class="nav-link" href="/status">Status</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row">
            <!-- Tools Panel -->
            <div class="col-md-3">
                <div class="card sticky-top">
                    <div class="card-header">
                        <h5><i class="fas fa-tools"></i> Annotation Tools</h5>
                    </div>
                    <div class="card-body">
                        <h6>Image: {{ filename }}</h6>
                        <small class="text-muted">{{ width }} Ã— {{ height }} pixels</small>
                        
                        <hr>
                        
                        <h6>Classes</h6>
                        <div id="classButtons" class="mb-3">
                            {% for i, class in enumerate(classes) %}
                            <button class="btn btn-sm btn-outline-primary mb-1 class-btn" 
                                    data-class-id="{{ i }}" 
                                    data-class-name="{{ class }}">
                                {{ class.replace('_', ' ').title() }}
                            </button>
                            {% endfor %}
                        </div>
                        
                        <h6>Instructions</h6>
                        <ol class="small">
                            <li>Select a class above</li>
                            <li>Click and drag on the image to create a bounding box</li>
                            <li>Drag boxes to move them</li>
                            <li>Drag the corner handle to resize</li>
                            <li>Click a box to select/delete it</li>
                            <li>Save when done</li>
                        </ol>
                        
                        <hr>
                        
                        <h6>Current Annotations: <span id="annotationCount">0</span></h6>
                        <div id="annotationList" class="mb-3"></div>
                        
                        <div class="d-grid gap-2">
                            <button id="clearAll" class="btn btn-warning btn-sm">
                                <i class="fas fa-trash"></i> Clear All
                            </button>
                            
                            <div class="btn-group">
                                <button id="saveTraining" class="btn btn-success">
                                    <i class="fas fa-save"></i> Save to Training
                                </button>
                                <button id="saveValidation" class="btn btn-info">
                                    <i class="fas fa-check"></i> Save to Validation
                                </button>
                            </div>
                            
                            <a href="/upload" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Back to Upload
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Image Panel -->
            <div class="col-md-9">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5><i class="fas fa-image"></i> Annotate: {{ filename }}</h5>
                        <span class="badge bg-primary">Click and drag to create boxes</span>
                    </div>
                    <div class="card-body text-center">
                        <div class="annotation-container" id="annotationContainer">
                            <img src="/uploaded/{{ filename }}" 
                                 class="annotation-image" 
                                 id="annotationImage"
                                 alt="Image to annotate">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Class Selection Modal -->
    <div class="modal fade" id="classModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Select Object Class</h5>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        {% for i, class in enumerate(classes) %}
                        <button class="btn btn-outline-primary class-select-btn" 
                                data-class-id="{{ i }}" 
                                data-class-name="{{ class }}"
                                data-bs-dismiss="modal">
                            {{ class.replace('_', ' ').title() }}
                        </button>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        class AnnotationTool {
            constructor() {
                this.annotations = [];
                this.currentClass = 0;
                this.currentClassName = '{{ classes[0] }}';
                this.isDrawing = false;
                this.isDragging = false;
                this.isResizing = false;
                this.selectedBox = null;
                this.startX = 0;
                this.startY = 0;
                this.currentBox = null;
                
                this.container = document.getElementById('annotationContainer');
                this.image = document.getElementById('annotationImage');
                
                this.setupEventListeners();
                this.updateAnnotationCount();
            }
            
            setupEventListeners() {
                // Class selection buttons
                document.querySelectorAll('.class-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        document.querySelectorAll('.class-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentClass = parseInt(btn.dataset.classId);
                        this.currentClassName = btn.dataset.className;
                    });
                });
                
                // Set first class as active
                document.querySelector('.class-btn').classList.add('active');
                
                // Mouse events for drawing
                this.container.addEventListener('mousedown', this.handleMouseDown.bind(this));
                this.container.addEventListener('mousemove', this.handleMouseMove.bind(this));
                this.container.addEventListener('mouseup', this.handleMouseUp.bind(this));
                
                // Save buttons
                document.getElementById('saveTraining').addEventListener('click', () => this.saveAnnotations('train'));
                document.getElementById('saveValidation').addEventListener('click', () => this.saveAnnotations('val'));
                document.getElementById('clearAll').addEventListener('click', this.clearAll.bind(this));
                
                // Prevent context menu
                this.container.addEventListener('contextmenu', e => e.preventDefault());
            }
            
            getRelativeCoordinates(e) {
                const rect = this.image.getBoundingClientRect();
                const scaleX = this.image.naturalWidth / this.image.width;
                const scaleY = this.image.naturalHeight / this.image.height;
                
                return {
                    x: (e.clientX - rect.left) * scaleX,
                    y: (e.clientY - rect.top) * scaleY,
                    displayX: e.clientX - rect.left,
                    displayY: e.clientY - rect.top
                };
            }
            
            handleMouseDown(e) {
                if (e.target.classList.contains('bounding-box') || e.target.classList.contains('resize-handle')) {
                    return; // Let box event handlers deal with this
                }
                
                const coords = this.getRelativeCoordinates(e);
                this.startX = coords.x;
                this.startY = coords.y;
                this.startDisplayX = coords.displayX;
                this.startDisplayY = coords.displayY;
                this.isDrawing = true;
                
                // Deselect any selected box
                this.deselectBox();
                
                // Create new box element
                this.currentBox = this.createBoundingBox(coords.displayX, coords.displayY, 0, 0);
                this.container.appendChild(this.currentBox);
            }
            
            handleMouseMove(e) {
                if (!this.isDrawing || !this.currentBox) return;
                
                const coords = this.getRelativeCoordinates(e);
                const width = Math.abs(coords.displayX - this.startDisplayX);
                const height = Math.abs(coords.displayY - this.startDisplayY);
                const left = Math.min(this.startDisplayX, coords.displayX);
                const top = Math.min(this.startDisplayY, coords.displayY);
                
                this.updateBoxDisplay(this.currentBox, left, top, width, height);
            }
            
            handleMouseUp(e) {
                if (!this.isDrawing || !this.currentBox) return;
                
                const coords = this.getRelativeCoordinates(e);
                const width = Math.abs(coords.x - this.startX);
                const height = Math.abs(coords.y - this.startY);
                
                // Remove box if too small
                if (width < 10 || height < 10) {
                    this.currentBox.remove();
                } else {
                    // Save annotation
                    const annotation = {
                        id: Date.now(),
                        class_id: this.currentClass,
                        class_name: this.currentClassName,
                        x: Math.min(this.startX, coords.x),
                        y: Math.min(this.startY, coords.y),
                        width: width,
                        height: height,
                        x_center: (Math.min(this.startX, coords.x) + width / 2),
                        y_center: (Math.min(this.startY, coords.y) + height / 2),
                        element: this.currentBox
                    };
                    
                    this.annotations.push(annotation);
                    this.currentBox.dataset.annotationId = annotation.id;
                    this.setupBoxEventListeners(this.currentBox);
                    this.updateBoxLabel(this.currentBox, this.currentClassName);
                }
                
                this.isDrawing = false;
                this.currentBox = null;
                this.updateAnnotationCount();
                this.updateAnnotationList();
            }
            
            createBoundingBox(x, y, width, height) {
                const box = document.createElement('div');
                box.className = 'bounding-box';
                box.style.left = x + 'px';
                box.style.top = y + 'px';
                box.style.width = width + 'px';
                box.style.height = height + 'px';
                
                // Add resize handle
                const handle = document.createElement('div');
                handle.className = 'resize-handle bottom-right';
                box.appendChild(handle);
                
                return box;
            }
            
            updateBoxDisplay(box, x, y, width, height) {
                box.style.left = x + 'px';
                box.style.top = y + 'px';
                box.style.width = width + 'px';
                box.style.height = height + 'px';
            }
            
            updateBoxLabel(box, className) {
                let label = box.querySelector('.box-label');
                if (!label) {
                    label = document.createElement('div');
                    label.className = 'box-label';
                    box.appendChild(label);
                }
                label.textContent = className.replace('_', ' ');
            }
            
            setupBoxEventListeners(box) {
                box.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (this.selectedBox === box) {
                        this.deleteBox(box);
                    } else {
                        this.selectBox(box);
                    }
                });
                
                // Add drag and resize functionality here if needed
            }
            
            selectBox(box) {
                this.deselectBox();
                this.selectedBox = box;
                box.classList.add('selected');
            }
            
            deselectBox() {
                if (this.selectedBox) {
                    this.selectedBox.classList.remove('selected');
                    this.selectedBox = null;
                }
            }
            
            deleteBox(box) {
                const annotationId = parseInt(box.dataset.annotationId);
                this.annotations = this.annotations.filter(ann => ann.id !== annotationId);
                box.remove();
                this.deselectBox();
                this.updateAnnotationCount();
                this.updateAnnotationList();
            }
            
            clearAll() {
                if (confirm('Are you sure you want to clear all annotations?')) {
                    this.annotations = [];
                    document.querySelectorAll('.bounding-box').forEach(box => box.remove());
                    this.deselectBox();
                    this.updateAnnotationCount();
                    this.updateAnnotationList();
                }
            }
            
            updateAnnotationCount() {
                document.getElementById('annotationCount').textContent = this.annotations.length;
            }
            
            updateAnnotationList() {
                const list = document.getElementById('annotationList');
                list.innerHTML = '';
                
                this.annotations.forEach((ann, index) => {
                    const item = document.createElement('div');
                    item.className = 'small mb-1';
                    item.innerHTML = `
                        <span class="badge bg-secondary">${index + 1}</span>
                        ${ann.class_name.replace('_', ' ')}
                    `;
                    list.appendChild(item);
                });
            }
            
            saveAnnotations(datasetType) {
                if (this.annotations.length === 0) {
                    alert('No annotations to save!');
                    return;
                }
                
                const data = {
                    filename: '{{ filename }}',
                    annotations: this.annotations.map(ann => ({
                        class_id: ann.class_id,
                        x_center: ann.x_center,
                        y_center: ann.y_center,
                        width: ann.width,
                        height: ann.height
                    })),
                    dataset_type: datasetType
                };
                
                fetch('/save_annotations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    if (result.success) {
                        alert(`Annotations saved to ${datasetType} dataset!`);
                        window.location.href = '/upload';
                    } else {
                        alert('Error saving annotations: ' + result.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error saving annotations');
                });
            }
        }
        
        // Initialize annotation tool when image is loaded
        document.getElementById('annotationImage').addEventListener('load', () => {
            new AnnotationTool();
        });
    </script>
</body>
</html>